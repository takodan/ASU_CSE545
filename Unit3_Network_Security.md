# Internet
## 網路協議
1. 這裡指的主要是TCP/IP, 基礎是抽象和封裝
2. 分成多層
    1. 物理層
    2. 鏈路層
    3. 網路層: IP
    4. 傳輸層: TCP, UDP
    5. 應用層: HTTP, SMTP, DNS, NFS
3. IP 地址
    1. 主機網路解口可以有多個IP
    2. IPv4 包含32bits，寫法例如255.255.255.255
    3. 一開始IPv4 有分類別, 但地址不夠使用而推行CIDR無類別域間路由
    4. 有部分IP被用來當作特殊地址
    5. IP只提供基礎傳輸服務, 用來連接不同子網路, 其他功能會由上層協議提供
4. IP 報 RFC791
    1. IP 報頭
        1. 共20bytes
        2. 版本(4bits)
        3. 報頭長度(4bits): 4字字節數量
        4. 服務類型(8bits)
        5. 總長(16bits): 最長為65535bytes
        6. ID(16bits)
        7. 標記(3bits)和偏移(13bits)
        8. 存活時間(8bits): TTL
        9. 協議(8bits): 例如TCP, UDP
        10. 較驗(16bits): 
        11. 地址(32bits+32bits): 來源和目標IP地址


## Ethernet
1. 為一種鏈路層協議
2. Ethernet frame乙太幀包含
    1. 地址(48bits+48bits): 來源和目標MAC地址
    2. 運送封包類型(2bytes): IP, ARP, RARP
    3. 數據(46bytes~1500bytes): ARP 和RARP 數據只有28bytes 需要pad
    4. CRC較驗
3. ARP地址解析協議
    1. 用來直接取得MAC地址, 不需要用到IP封裝
    2. 包含
        1. 硬件類型(2bytes), 協議類型(2bytes)
        2. 硬件大小(1bytes), 協議大小(1bytes)
        3. 操作(2bits): 是請求還是回應
        4. 源MAC, IP
        5. 目標MAC, IP
    3. 實例
        1. A想知道B的MAC
        2. A廣播ARP請求, 此請求包含B的IP但不包含B的MAC, 等待有此IP 地址的主機回應
        3. B回應MAC 地址 
        4. A和B的會藉此儲存彼此的MAC 地址
4. 區域網攻擊
    1. 目標
        1. 模擬偽裝其他主機
        2. 拒絕服務
        3. 獲取訊息
        4. 竄改機制
    2. 早期hub集線器會傳送數據給所有主機
    3. 現代switch交會機可以限制傳送數據給目標主機
5. 網路嗅探
    1. 將網路接口設定成promiscuous mode混雜模式, 可以接收所有經過的數據
    2. 早期許多協議驗證都是以明文傳輸, 嗅探可以直接取得許多資訊
    3. 嗅探工具
        1. Linux 命令列
            1. tcpdump: 收集數據流
            2. tcpflow: 從數據流組合出TCP流
            3. tcpreplay: 重放收集到的數據流
        2. Wireshark軟體提供多種工具
    4. switch 因為會限制傳送目標, 所以無法直接嗅探
    5. 防禦
        1. 本地主機如果有網路接口開啟promiscuous mode混雜模式, 代表可能有程式在試圖嗅探
        2. 注意可疑的ARP 活動, 嗅探多會包還ARP 攻擊
        3. 注意可疑的DNS請求, 製造陷阱: 嘗試連接不存在IP地址, 檢測是否有其他對不存在IP 的DNS 請求
        4. 如果某主機因為你發送訊息給其他主機而增加延遲, 某主機可能是因為混雜模式增加系統負擔導致延遲
        5. 用錯誤的MAC 和正確的IP 發送ICMP ,如果該主機有回應代表可能在嗅探
        6. AnitSniff 工具實現了上面的一些防禦手段
6. MAC 溢出攻擊
    1. switch 會緩存MAC 地址和對應端口, 假如緩存溢出可能會使switch法找到對應端口
    2. switch會將數據發送到所有端口
7. MAC 克隆
    1. 攻擊者偽裝成受害主機的MAC, 使switch發送數據給攻擊者和受害主機
    2. 多會配合ARP 欺騙攻擊
8. ARP 欺騙攻擊
    1. ARP 會接受非自己請求的回應, 以方便紀錄網路中的其他主機MAC
    2. 實例
        1. 攻擊者C發送給受害主機A和B假的ARP回應, 使A和B的ARP表都對應到C的MAC
        2. A要發送訊息給B, 但是因為B的IP 對應的是C的MAC, 訊息實際上會傳送給C
    3. 嗅探和ARP 攻擊工具
        1. Dsniff
        2. Ettercap
    4. 防禦
        1. 使用靜態ARP, 但是會使網路管理困難, 多只使用於關鍵主機IP
        2. 忽略非自己請求的ARP 回應, 但是被攔截到ARP 請求一樣會被攻擊
        3. 在ARP緩存超時才接受新的ARP 回應
        4. 監控ARP 變化, 例如使用arpwatch


## IP 和路由攻擊
1. 攻擊都會需要物理訪問, 利用IEEE 802.1X 訪問控制協議來實現驗證權限
2. IP 欺騙攻擊
    1. 攻擊者偽裝成其他主機的IP 傳送封包給受害主機
    2. 但是MAC地址會是攻擊者原本的
    3. 許多權限驗證都是基於IP, 攻擊者藉此達到模擬或欺騙
3. IP 欺騙工具
    1. hping3
    2. libnet: a C library
    3. Scapy: a Python library
4. 數據傳送
    1. IP 位於同一子網路, 主機間可以藉由MAC 地址直接通訊
    2. 如過不同子網, 主機會藉由MAC 地址會傳送到作為gateway的路由
    3. 路由會判斷IP 決定下一個路由MAC地址, 直到傳送到目標主機
5. 路由類型
    1. 逐跳路由算法: 每個路由只會計算下個路由位置, 每個路由會有自己的路由表作為計算依據
    2. 源路由算法: 數據再發送前就決定好傳遞路徑, 較容易被攻擊使得數據得經由攻擊者路由
6. 盲IP 欺騙
    1. 同樣偽裝封包成其他IP, 但是重點在受害主機會因此傳訊息給源IP 的主機
7. 中間人攻擊
    1. 包含嗅探, 攔截或阻止, 修改
